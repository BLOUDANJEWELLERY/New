<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stereo Pair Capture with Smart Motion Detection</title>
  <style>
    body {
      text-align: center;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    h2 {
      margin-top: 20px;
    }
    #videoContainer {
      position: relative;
      display: inline-block;
      max-width: 100%;
    }
    #video,
    #ghostOverlay {
      width: 100%;
      max-width: 640px;
      height: auto;
      border: 2px solid black;
    }
    #ghostOverlay {
      position: absolute;
      top: 0;
      left: 0;
      opacity: 0.4;
      pointer-events: none;
      display: none;
    }
    #buttons {
      margin-top: 10px;
    }
    #images {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }
    #images img {
      width: 100%;
      max-width: 300px;
      height: auto;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h2>Capture Stereo Pair Images</h2>
  <div id="videoContainer">
    <video id="video" autoplay playsinline></video>
    <img id="ghostOverlay" src="" alt="Ghost Overlay" />
  </div>
  <div id="buttons">
    <button id="captureLeft">Capture Left Image</button>
    <button id="captureRight" disabled>Auto Capture Right Image</button>
  </div>
  <canvas id="canvas" style="display: none;"></canvas>
  <div id="images">
    <img id="leftImage" alt="Left Image" />
    <img id="rightImage" alt="Right Image" />
  </div>

  <script>
    const video = document.getElementById("video");
    const captureLeftBtn = document.getElementById("captureLeft");
    const captureRightBtn = document.getElementById("captureRight");
    const canvas = document.getElementById("canvas");
    const leftImage = document.getElementById("leftImage");
    const rightImage = document.getElementById("rightImage");
    const ghostOverlay = document.getElementById("ghostOverlay");

    let stream;
    let leftTaken = false;
    let leftFrameData = null; // stores the left image pixel data
    // Thresholds for our region checks (tweak these as needed)
    const LEFT_REGION_THRESHOLD = 8;   // average difference in left quarter must be low
    const RIGHT_REGION_THRESHOLD = 20; // average difference in right quarter must be high
    const RATIO_THRESHOLD = 2;         // ratio of right-to-left difference must be high enough

    // Request the back camera on mobile (and default camera on desktop)
    navigator.mediaDevices
      .getUserMedia({ video: { facingMode: "environment" } })
      .then((s) => {
        stream = s;
        video.srcObject = stream;
      })
      .catch((error) => {
        console.error("Error accessing webcam: ", error);
      });

    // Capture an image from the video feed, return its data URL
    function captureImage(imageElement) {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const dataURL = canvas.toDataURL("image/png");
      imageElement.src = dataURL;
      return dataURL;
    }

    // Computes average per-pixel difference for a given vertical region [startX, endX)
    function getRegionDifference(imgData1, imgData2, startX, endX) {
      const { width, height, data: data1 } = imgData1;
      const data2 = imgData2.data;
      let diffSum = 0;
      let count = 0;
      // iterate through every row in the region defined by startX, endX
      for (let y = 0; y < height; y++) {
        for (let x = startX; x < endX; x++) {
          const index = (y * width + x) * 4;
          const rDiff = Math.abs(data1[index] - data2[index]);
          const gDiff = Math.abs(data1[index + 1] - data2[index + 1]);
          const bDiff = Math.abs(data1[index + 2] - data2[index + 2]);
          const avgPixelDiff = (rDiff + gDiff + bDiff) / 3;
          diffSum += avgPixelDiff;
          count++;
        }
      }
      return diffSum / count;
    }

    // When left image is captured, show ghost overlay and start motion detection.
    captureLeftBtn.addEventListener("click", () => {
      // Capture left image and display it.
      captureImage(leftImage);
      ghostOverlay.src = leftImage.src;
      ghostOverlay.style.display = "block";
      leftTaken = true;
      captureLeftBtn.disabled = true;
      captureRightBtn.disabled = false;
      alert("Left image captured. Now move the camera slightly to the right (without zoom changes) until the capture is triggered.");

      // Store the pixel data of the left image.
      const ctx = canvas.getContext("2d");
      leftFrameData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      // Start the motion check loop.
      setTimeout(detectMotion, 500);
    });

    // Checks if the camera has shifted slightly right (with negligible zoom change)
    function detectMotion() {
      if (!leftTaken) return; // safety check

      // Capture the current frame from the live video.
      const tempCanvas = document.createElement("canvas");
      tempCanvas.width = video.videoWidth;
      tempCanvas.height = video.videoHeight;
      const tempCtx = tempCanvas.getContext("2d");
      tempCtx.drawImage(video, 0, 0, tempCanvas.width, tempCanvas.height);
      const currentFrameData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);

      // Determine region boundaries.
      const width = leftFrameData.width;
      const leftRegionEnd = Math.floor(width / 4);
      const rightRegionStart = Math.floor((3 * width) / 4);

      // Compute average differences for the left and right quarters.
      const leftDiff = getRegionDifference(leftFrameData, currentFrameData, 0, leftRegionEnd);
      const rightDiff = getRegionDifference(leftFrameData, currentFrameData, rightRegionStart, width);
      console.log("Left Region Diff:", leftDiff, "Right Region Diff:", rightDiff);

      // Check if left part stays nearly the same but right has moved:
      if (
        leftDiff < LEFT_REGION_THRESHOLD &&
        rightDiff > RIGHT_REGION_THRESHOLD &&
        (rightDiff / (leftDiff + 0.1)) > RATIO_THRESHOLD  // add a small value to avoid division by zero
      ) {
        // Conditions met, auto-capture right image.
        captureImage(rightImage);
        ghostOverlay.style.display = "none";
        captureRightBtn.disabled = true;
        alert("Stereo pair captured automatically with optimal displacement!");
      } else {
        // Not yet optimal; re-check after a short delay.
        setTimeout(detectMotion, 500);
      }
    }
  </script>
</body>
</html>